name: ecommerce-platform

networks:
  ecommerce-net:
    driver: bridge

services:
  # ===============================================================
  # KAFKA (KRaft â€“ FIXED)
  # ===============================================================
  kafka:
    image: apache/kafka:3.7.0
    container_name: kafka
    ports:
      - "9092:9092"
    environment:
      KAFKA_NODE_ID: 1
      KAFKA_PROCESS_ROLES: broker,controller
      KAFKA_CONTROLLER_QUORUM_VOTERS: 1@kafka:9093

      KAFKA_LISTENERS: PLAINTEXT://kafka:9092,CONTROLLER://kafka:9093
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,CONTROLLER:PLAINTEXT
      KAFKA_CONTROLLER_LISTENER_NAMES: CONTROLLER
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT

      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 1
    networks: [ ecommerce-net ]
    restart: unless-stopped

  # ---- KRaft storage formatter (MANDATORY) ----
  kafka-init:
    image: apache/kafka:3.7.0
    depends_on:
      - kafka
    networks: [ ecommerce-net ]
    command: >
      bash -c "
        CLUSTER_ID=$$(/opt/kafka/bin/kafka-storage.sh random-uuid) &&
        /opt/kafka/bin/kafka-storage.sh format
          -t $$CLUSTER_ID
          -c /opt/kafka/config/kraft/server.properties
          --ignore-formatted
      "

  # ===============================================================
  # GO MICROSERVICES
  # ===============================================================
  api-gateway:
    build:
      context: .
      dockerfile: Dockerfile.services
      target: api-gateway
    image: ecommerce/api-gateway:local
    ports:
      - "8080:8080"
    environment:
      - KAFKA_BROKERS=kafka:9092
      - AUTH_SERVICE_URL=http://auth-service:8080
      - USER_SERVICE_URL=http://user-service:8080
      - OFFER_SERVICE_URL=http://offer-service:8080
      - CART_SERVICE_URL=http://cart-service:8080
      - STOREFRONT_SERVICE_URL=http://storefront-service:8080
    depends_on:
      - kafka
    networks: [ ecommerce-net ]
    restart: unless-stopped

  auth-service:
    build:
      context: .
      dockerfile: Dockerfile.services
      target: auth-service
    image: ecommerce/auth-service:local
    ports: [ "8081:8080" ]
    environment:
      - KAFKA_BROKERS=kafka:9092
    depends_on: [ kafka ]
    networks: [ ecommerce-net ]
    restart: unless-stopped

  user-service:
    build:
      context: .
      dockerfile: Dockerfile.services
      target: user-service
    image: ecommerce/user-service:local
    ports: [ "8082:8080" ]
    environment:
      - KAFKA_BROKERS=kafka:9092
    depends_on: [ kafka ]
    networks: [ ecommerce-net ]
    restart: unless-stopped

  admin-backoffice-service:
    build:
      context: .
      dockerfile: Dockerfile.services
      target: admin-backoffice-service
    image: ecommerce/admin-backoffice-service:local
    ports: [ "8083:8080" ]
    environment:
      - KAFKA_BROKERS=kafka:9092
    depends_on: [ kafka ]
    networks: [ ecommerce-net ]
    restart: unless-stopped

  analytics-ingest-service:
    build:
      context: .
      dockerfile: Dockerfile.services
      target: analytics-ingest-service
    image: ecommerce/analytics-ingest-service:local
    ports: [ "8084:8080" ]
    environment:
      - KAFKA_BROKERS=kafka:9092
    depends_on: [ kafka ]
    networks: [ ecommerce-net ]
    restart: unless-stopped

  attribution-service:
    build:
      context: .
      dockerfile: Dockerfile.services
      target: attribution-service
    image: ecommerce/attribution-service:local
    ports: [ "8085:8080" ]
    environment:
      - KAFKA_BROKERS=kafka:9092
    depends_on: [ kafka ]
    networks: [ ecommerce-net ]
    restart: unless-stopped

  audit-service:
    build:
      context: .
      dockerfile: Dockerfile.services
      target: audit-service
    image: ecommerce/audit-service:local
    ports: [ "8086:8080" ]
    environment:
      - KAFKA_BROKERS=kafka:9092
    depends_on: [ kafka ]
    networks: [ ecommerce-net ]
    restart: unless-stopped

  cart-service:
    build:
      context: .
      dockerfile: Dockerfile.services
      target: cart-service
    image: ecommerce/cart-service:local
    ports: [ "8087:8080" ]
    environment:
      - KAFKA_BROKERS=kafka:9092
    depends_on: [ kafka ]
    networks: [ ecommerce-net ]
    restart: unless-stopped

  conversion-webhook:
    build:
      context: .
      dockerfile: Dockerfile.services
      target: conversion-webhook
    image: ecommerce/conversion-webhook:local
    ports: [ "8088:8080" ]
    environment:
      - KAFKA_BROKERS=kafka:9092
    depends_on: [ kafka ]
    networks: [ ecommerce-net ]
    restart: unless-stopped

  feature-flag-service:
    build:
      context: .
      dockerfile: Dockerfile.services
      target: feature-flag-service
    image: ecommerce/feature-flag-service:local
    ports: [ "8089:8080" ]
    environment:
      - KAFKA_BROKERS=kafka:9092
    depends_on: [ kafka ]
    networks: [ ecommerce-net ]
    restart: unless-stopped

  landing-service:
    build:
      context: .
      dockerfile: Dockerfile.services
      target: landing-service
    image: ecommerce/landing-service:local
    ports: [ "8090:8080" ]
    environment:
      - KAFKA_BROKERS=kafka:9092
    depends_on: [ kafka ]
    networks: [ ecommerce-net ]
    restart: unless-stopped

  notification-service:
    build:
      context: .
      dockerfile: Dockerfile.services
      target: notification-service
    image: ecommerce/notification-service:local
    ports: [ "8091:8080" ]
    environment:
      - KAFKA_BROKERS=kafka:9092
    depends_on: [ kafka ]
    networks: [ ecommerce-net ]
    restart: unless-stopped

  offer-service:
    build:
      context: .
      dockerfile: Dockerfile.services
      target: offer-service
    image: ecommerce/offer-service:local
    ports: [ "8092:8080" ]
    environment:
      - KAFKA_BROKERS=kafka:9092
    depends_on: [ kafka ]
    networks: [ ecommerce-net ]
    restart: unless-stopped

  redirect-service:
    build:
      context: .
      dockerfile: Dockerfile.services
      target: redirect-service
    image: ecommerce/redirect-service:local
    ports: [ "8093:8080" ]
    environment:
      - KAFKA_BROKERS=kafka:9092
    depends_on: [ kafka ]
    networks: [ ecommerce-net ]
    restart: unless-stopped

  reporting-service:
    build:
      context: .
      dockerfile: Dockerfile.services
      target: reporting-service
    image: ecommerce/reporting-service:local
    ports: [ "8094:8080" ]
    environment:
      - KAFKA_BROKERS=kafka:9092
    depends_on: [ kafka ]
    networks: [ ecommerce-net ]
    restart: unless-stopped

  storefront-service:
    build:
      context: .
      dockerfile: Dockerfile.services
      target: storefront-service
    image: ecommerce/storefront-service:local
    ports: [ "8095:8080" ]
    environment:
      - PORT=8080
      - KAFKA_BROKERS=kafka:9092
    depends_on: [ kafka ]
    networks: [ ecommerce-net ]
    restart: unless-stopped
