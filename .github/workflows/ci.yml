name: Platform CI/CD

on:
  push:
    branches: ["main"]
    paths-ignore:
      - "**.md"
      - "docs/**"
  pull_request:
    branches: ["main"]
    paths-ignore:
      - "**.md"
      - "docs/**"

permissions:
  contents: read
  id-token: write
  security-events: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: ${{ github.ref != 'refs/heads/main' }}

env:
  GKE_CLUSTER: ecommerce-prod
  GKE_REGION: us-central1
  GAR_REGION: us-central1-docker.pkg.dev
  ARTIFACT_REPO: ecommerce-repo
  TF_WORKING_DIR: infra/gke
  GO_VERSION: "1.22.0"

# =====================================================
# 0. QUALITY GATE
# =====================================================
jobs:
  quality-check:
    name: Code Quality
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true
          cache-dependency-path: go.work.sum

      - name: Test & Lint
        run: |
          set -e
          cd services
          go test ./... -coverprofile=../coverage.out
          go install github.com/mgechev/revive@v1.3.7
          revive ./... > ../lint-report.txt

      - uses: actions/upload-artifact@v4
        with:
          name: test-reports
          path: |
            coverage.out
            lint-report.txt

# =====================================================
# 1. BUILD CHECK
# =====================================================
  build-services:
    name: Compile Services
    runs-on: ubuntu-latest
    needs: quality-check
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Build
        run: |
          cd services
          go build ./...

# =====================================================
# 2. SECURITY SCAN
# =====================================================
  security-scan:
    name: Trivy Scan
    runs-on: ubuntu-latest
    needs: build-services
    steps:
      - uses: actions/checkout@v4

      - uses: aquasecurity/trivy-action@0.16.1
        with:
          scan-type: fs
          severity: CRITICAL,HIGH
          ignore-unfixed: true
          exit-code: 1

# =====================================================
# 3. SONARQUBE
# =====================================================
  sonarqube:
    name: SonarQube
    runs-on: ubuntu-latest
    needs: quality-check
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/download-artifact@v4
        with:
          name: test-reports

      - uses: sonarsource/sonarqube-scan-action@v2
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
        with:
          args: >
            -Dsonar.go.coverage.reportPaths=coverage.out

# =====================================================
# 4. TERRAFORM (ONLY IF INFRA CHANGED)
# =====================================================
  terraform:
    name: Terraform Infra
    runs-on: ubuntu-latest
    needs: security-scan
    environment: prod

    permissions:
      contents: read
      id-token: write

    env:
      TF_VAR_project_id: ${{ secrets.GCP_PROJECT_ID }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for Infra Changes
        id: filter
        run: |
          # Check if infra/terraform changed in the push
          changed_files=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }} || echo "")
          if echo "$changed_files" | grep -q "infra/terraform/"; then
            echo "changes=true" >> $GITHUB_OUTPUT
          else
            echo "changes=false" >> $GITHUB_OUTPUT
          fi

      - uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: projects/662443466894/locations/global/workloadIdentityPools/terraform-pool-2/providers/github
          service_account: terraform-sa@${{ secrets.GCP_PROJECT_ID }}.iam.gserviceaccount.com

      - uses: hashicorp/setup-terraform@v3
        if: steps.filter.outputs.changes == 'true'
        with:
          terraform_version: 1.6.6

      - run: terraform init
        if: steps.filter.outputs.changes == 'true'
        working-directory: ${{ env.TF_WORKING_DIR }}

      - run: terraform validate
        if: steps.filter.outputs.changes == 'true'
        working-directory: ${{ env.TF_WORKING_DIR }}

      - run: terraform plan -out=tfplan
        if: steps.filter.outputs.changes == 'true'
        working-directory: ${{ env.TF_WORKING_DIR }}

      - uses: actions/upload-artifact@v4
        if: steps.filter.outputs.changes == 'true'
        with:
          name: tfplan
          path: infra/gke/tfplan

      - if: github.ref == 'refs/heads/main' && steps.filter.outputs.changes == 'true'
        run: terraform apply -auto-approve tfplan
        working-directory: ${{ env.TF_WORKING_DIR }}

# =====================================================
# 5. PLATFORM BOOTSTRAP
# =====================================================
  platform-bootstrap:
    name: Kubernetes Bootstrap
    runs-on: ubuntu-latest
    needs: terraform
    if: github.ref == 'refs/heads/main'
    environment: prod

    steps:
      - uses: actions/checkout@v4

      - uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: projects/662443466894/locations/global/workloadIdentityPools/terraform-pool-2/providers/github
          service_account: terraform-sa@${{ secrets.GCP_PROJECT_ID }}.iam.gserviceaccount.com

      - uses: google-github-actions/setup-gcloud@v2
        with:
          install_components: gke-gcloud-auth-plugin

      - run: |
          gcloud container clusters get-credentials $GKE_CLUSTER \
            --region $GKE_REGION \
            --project ${{ secrets.GCP_PROJECT_ID }}

      - run: kubectl apply -R -f infra/namespaces

# =====================================================
# 6. BUILD & DEPLOY SERVICES
# =====================================================
  services-deploy:
    name: Deploy Services
    runs-on: ubuntu-latest
    needs: platform-bootstrap
    if: github.ref == 'refs/heads/main'
    environment: prod

    steps:
      - uses: actions/checkout@v4

      - uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: projects/662443466894/locations/global/workloadIdentityPools/terraform-pool-2/providers/github
          service_account: terraform-sa@${{ secrets.GCP_PROJECT_ID }}.iam.gserviceaccount.com

      - uses: google-github-actions/setup-gcloud@v2

      - run: gcloud auth configure-docker $GAR_REGION --quiet

      - name: Build & Push Images
        run: |
          set -e
          # Optimization: Identify changed files to minimize build blast radius
          CHANGED=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }} || echo "")

          for svc in services/*; do
            if [ -f "$svc/Dockerfile" ]; then
              NAME=$(basename "$svc")
              # Monorepo optimization: Only build if service folder OR shared-lib changed
              if echo "$CHANGED" | grep -qE "services/$NAME/|services/shared-lib/"; then
                echo "Building $NAME (Detected Changes)"
                IMAGE="$GAR_REGION/${{ secrets.GCP_PROJECT_ID }}/$ARTIFACT_REPO/$NAME:${{ github.sha }}"
                docker build -t $IMAGE -f "$svc/Dockerfile" .
                docker push $IMAGE
              else
                 echo "Skipping $NAME (No Changes)"
              fi
            fi
          done

      - run: |
          gcloud container clusters get-credentials $GKE_CLUSTER \
            --region $GKE_REGION \
            --project ${{ secrets.GCP_PROJECT_ID }}

      - name: Helm Deploy
        run: |
          set -e
          CHANGED=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }} || echo "")

          for svc in services/*; do
            if [ -d "$svc/helm" ]; then
              NAME=$(basename "$svc")
              # Optimization: Only deploy if service code OR helm chart changed
              if echo "$CHANGED" | grep -qE "services/$NAME/|services/shared-lib/"; then
                 echo "Deploying $NAME (Detected Changes)"
                 helm upgrade --install $NAME "$svc/helm" \
                   --namespace ecommerce \
                   --create-namespace \
                   --set global.image.registry=$GAR_REGION \
                   --set global.image.project=${{ secrets.GCP_PROJECT_ID }} \
                   --set global.image.repository=$ARTIFACT_REPO \
                   --set image.tag=${{ github.sha }} \
                   --wait --timeout 5m
              else
                 echo "Skipping Deploy for $NAME (No Changes)"
              fi
            fi
          done
